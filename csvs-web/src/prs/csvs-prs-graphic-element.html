<!--link rel="import" href="../bower_components/polymer/polymer.html"-->
<!--link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html"-->
<link rel="import" href="./csvs-prs-graphic-info.html">

<dom-module name="csvs-prs-graphic-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            width: 100%;
            background-color: var(--text-primary-color);
            color: var(--primary-text-color);
        }

        #menuSeqType {
            margin-top: 15px;
        }

        #menuSeqType> div {
            font-size: 17px;
            padding: 5px;
            margin: 0 20px;
            border-bottom: 2px solid transparent;
            transition: all 0.1s;
            cursor: pointer;
        }

        #menuSeqType> div:hover {
            border-bottom-color: rgba(125, 125, 125, 0.4);
        }

        #menuSeqType> div[selected] {
            border-bottom-color: rgba(125, 125, 125, 0.7);
        }

        #prsGraphicInfo{
             padding: 0px 40px;
        }

    </style>
    <template>
        <div hidden$="{{isLoading}}">
            <div id="menuSeqType" class="color-2 color-hover-2 horizontal layout ">
                <div id="menuSeqTypeG" on-click="handleMenuSeqTypeClick" option="G" selected="" hidden$="{{_hiddenMenu('G')}}">Genome</div>
                <div id="menuSeqTypeE" on-click="handleMenuSeqTypeClick" option="E" hidden$="{{_hiddenMenu('E')}}">Exome</div>
            </div>
            <div id="divGraphicPrs" class="horizontal layout style-scope" style="display: inline-flex; padding-top: 15px;" hidden$="{{_hiddenMenu('')}}">
                <csvs-prs-graphic-info  idPgs="{{idPgsSelected}}" id="prsGraphicInfo"></csvs-prs-graphic-info>
                <div id="chartPrs" class="color-2 color-hover-2 horizontal layout center-justified"></div>
            </div>
            <div id="divGraphicPrsNoData" class="horizontal layout style-scope" style="padding-top: 15px;" hidden$="{{!_hiddenMenu('')}}">
                No results found.
            </div>
        </div>
        <div hidden$="{{!isLoading}}">
            <div id="divGraphicLoading" class="color-2 color-hover-2 horizontal layout" style="font-size: 17px;padding: 5px;margin: 20px 20px;">
                Loading...
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-prs-graphic-element',
        properties: {
            idPgsSelected: {
                type: String,
                value : "",
                observer: 'getDataGraphic'
            },
            diseases:{
                type: Array,
                value: function() {
                    return [];
                },
                observer: 'getDataGraphic'
            },
            isLoading:{
                type: Boolean,
                value: false
            },
            efosLabels: {
                type: String,
                value : ""
            },
            selectedSequencingType:{
                value: "",
                type: String,
                observer: 'reloadChart'
            },
            dataGraphic:{
                type: Array,
                value: []
            },
            menuSequencingType:{
                type: Array,
                value: [],
                observer: 'reloadMenu'
            }
        },

        ready: function() {
        },

        _hiddenMenu: function(option){
            var result = true;
            if (this.dataGraphic != null) {
                if (option === "G") {
                    result = this.dataGraphic.some(dg=>dg.genome != null) ? false : true;
                }

                if (option === "E") {
                    result = this.dataGraphic.some(dg=>dg.exome != null) ? false : true;
                }
            }
            return result;
        },

        reloadMenu: function(){
            this.$.divGraphicPrs.setAttribute("hidden", "true");
            this.$.divGraphicPrsNoData.removeAttribute("hidden");
            // Remove hidden
            if (this._hiddenMenu("G")){
                    this.$.menuSeqTypeG.setAttribute("hidden", "true");
            } else {
                    this.$.menuSeqTypeG.removeAttribute("hidden");
                    this.$.divGraphicPrs.removeAttribute("hidden");
                    this.$.divGraphicPrsNoData.setAttribute("hidden", "true");
            }
            if (this._hiddenMenu("E")){
                    this.$.menuSeqTypeE.setAttribute("hidden", "true");
            } else {
                    this.$.menuSeqTypeE.removeAttribute("hidden");
                    this.$.divGraphicPrs.removeAttribute("hidden");
                    this.$.divGraphicPrsNoData.setAttribute("hidden", "true");
            }
        },

        formatFixed: function (num, f){
            //console.log("fixed num= ",num," numDec=" ,f, " return = ", ((Math.round(num * Math.pow(10, f))) / (Math.pow(10, f)).toFixed(f))*1);
            return ((Math.round(num * Math.pow(10, f))) / (Math.pow(10, f)).toFixed(f))*1;
        },

        formatExpo: function(x, f) {
            if (x != 0){
              //  console.log("graphic num= ",x," numDec=" ,f, "    abs<0.01=", Math.abs(Number.parseFloat(x))  < 0.01, "     final round=", Math.abs(Number.parseFloat(x)) < 0.01 ? Number.parseFloat(x).toExponential(f) :
                this.formatFixed(Number.parseFloat(x), f))

                return Math.abs(Number.parseFloat(x)) < 0.01 ?
                    Number.parseFloat(x).toExponential(f) :
                    this.formatFixed(Number.parseFloat(x), f);
            } else {
                return 0;
            }
        },

       reloadChart: function() {
            var data = [];
            var categories = [];
            this.$.prsGraphicInfo.idPgs = this.idPgsSelected;
            var me = this;
            // Remove selected
            if (this.selectedSequencingType == "G"){
                    this.$.menuSeqType.children.namedItem("menuSeqTypeG").setAttribute("selected", "true");
                    this.$.menuSeqType.children.namedItem("menuSeqTypeE").removeAttribute("selected");
                    this.$.prsGraphicInfo.dataGraphic = this.dataGraphic.filter(dg=>dg.genome != null).map(dg=>dg.genome);
                    data = this.dataGraphic.filter(dg=>dg.genome != null).map(dg=>dg.genome)
            }
            if (this.selectedSequencingType == "E"){
                    this.$.menuSeqType.children.namedItem("menuSeqTypeG").removeAttribute("selected");
                    this.$.menuSeqType.children.namedItem("menuSeqTypeE").setAttribute("selected", "true");
                    this.$.prsGraphicInfo.dataGraphic = this.dataGraphic.filter(dg=>dg.exome != null).map(dg=>dg.exome);
                    data = this.dataGraphic.filter(dg=>dg.exome != null).map(dg=>dg.exome)
            }

            var listColors =  this.selectedSequencingType === "E" ?  ["#90ed7d",'#363636'] : ["#7cb5ec",'#363636'];
            if (data.length > 0) {
                var vpp = new Highcharts.Chart("chartPrs",{
                    colors: listColors,
                    plotOptions: {
                        histogram: {
                           /* accessibility: {
                                point: {
                                    valueDescriptionFormat: '{index}. {point.x:.3f} to {point.x2:.3f}, {point.y}.'
                                }
                            },*/
                            dataLabels: {
                                enabled: true,
                            }
                        }
                    },
                    title: {
                        text: this.efosLabels
                    },
                    xAxis: [{
                        title: { text: '' },
                        //alignTicks: false,
                        opposite: true,
                        visible: false,
                    }, {
                        title: { text: '' },
                       // alignTicks: true,
                        opposite: false,
                        startOnTick: false,
                        endOnTick: false,
                        tickPositioner: function () {
                          var positions = [];
                          for(var x in this.series[0].processedXData){
                            if (x % 2 == 0 || this.series[0].processedXData.length < 12){
                               positions.push(me.formatExpo(this.series[0].processedXData[x], 3));
                            }
                          }
                          return positions;
                        },

                    }],
                    tooltip: {
                        formatter: function () {
                            return ' Range: <b>[' + me.formatExpo(this.point.x, 3) + ',' + me.formatExpo(this.point.x2, 3) + ']</b><br> Frequency: <b>' + this.point.y + '</b>';
                        },
                        shared: true,
                        useHTML: true,
                    },
                    yAxis: [{
                          title: { text: 'Data' },
                          visible: false,
                          opposite: true
                      }, {
                          title: { text: 'Histogram' },
                          visible: false
                      }],
                    series: [{
                            name: this.selectedSequencingType === "E" ? "Exome histogram" : "Genome histogram",
                            type: 'histogram',
                            xAxis: 1,
                            yAxis: 1,
                            baseSeries: 's1',
                            zIndex: -1,
                            visible: true,
                        }, {
                        name: "Data",
                        data: data,
                        type: 'scatter',
                        id: 's1',
                        marker: {
                            radius: 1.5
                        },
                        visible: false,
                        showInLegend: false
                    }]
                });
            }

            this.isLoading = false;
        },


        handleMenuSeqTypeClick: function(e) {
            var v = e.currentTarget.getAttribute("option");
            if ( v != this.selectedSequencingType) {
                // Remove selected
                if (this.selectedSequencingType != ""){
                    this.$.menuSeqType.children.namedItem("menuSeqType"+this.selectedSequencingType).removeAttribute("selected");
                }
                // Add selected
                this.selectedSequencingType = v;
                e.currentTarget.setAttribute("selected", "true");
                this.reloadChart();
            }
        },

        getDataGraphic: function() {
            var me = this;
            var newQuery = this.idPgsSelected != "" ? {"idPgs": this.idPgsSelected,limit:10, skip:0, "diseases": this.diseases} : {limit:10, skip:0, "diseases": this.disease};
            if (this.idPgsSelected != ""){
                CSVSManager.prs.graphic({
                    query: newQuery,
                    request: {
                        success: function(response) {
                            me.dataGraphic = response.result;
                            var menuSequencingTypeTmp = [];
                            if ( response.result.length > 0) {
                                if (response.result.findIndex((r)=> r.genome != null) !== -1){
                                    menuSequencingTypeTmp.push("G");
                                }
                                if (response.result.findIndex((r)=> r.exome != null) !== -1){
                                    menuSequencingTypeTmp.push("E");
                                }
                                me.selectedSequencingType = menuSequencingTypeTmp[0];
                            } else {
                               me.selectedSequencingType = "";
                            }
                            me.menuSequencingType = menuSequencingTypeTmp;
                            try {
                               me.reloadChart();
                            } catch (e) {
                                //me.reloadChart();
                                console.log(e);
                            }
                        }
                    }
                });
            }
        },
    });
</script>