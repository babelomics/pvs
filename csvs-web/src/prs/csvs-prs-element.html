<!--link rel="import" href="../bower_components/polymer/polymer.html"-->
<link rel="import" href="./csvs-filter-prs.html">
<link rel="import" href="./csvs-table-prs.html">


<dom-module name="csvs-prs-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            position: relative;
            width: 100%;
            background-color: var(--text-primary-color);
            color: var(--primary-text-color);
        }

        #filter-form-element {
            background-color: #FFFFFF;
            width: 300px;
            margin: 20px;
            min-height: 900px;
        }

        #stv-filter-position {
            width: 300px;
        }

        stv-tooltip::shadow .closeInfo::shadow {
            margin-left: 490px;
        }


        #prsDiv {
            border-radius: 0px !important;
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 290px);
        }
        #diseases_div
        {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
    <template>

        <div class="horizontal layout">
            <div id="filter-form-element">
                <form class="vertical layout" id="filter_prs_form">
                    <div id="buttons_container" class="horizontal layout end-justified" style="margin:10px 5px;">
                        <div class="stv-btn stv-btn-shdw flex" on-click="clearForm" style="margin-right: 3px;">
                            Clear
                        </div>
                        <div class="stv-btn stv-btn-shdw flex" id="prsBtnSearch" on-click="submitForm">Search</div>
                    </div>
                    <csvs-filter-prs id="filterPrs"></csvs-filter-prs>
                    <stv-form-box>
                        <div class="header horizontal layout flex">
                            <div>Subpopulations</div>
                            <div class="flex"></div>
                            <div on-click="selectAllDiseases" title="Select all subpopulations">
                                <i class="fa fa-check-square-o check"></i>
                            </div>
                            <div on-click="deselectAllDiseases" title="Deselect all subpopulations">
                                <i class="fa fa-square-o check"></i>
                            </div>
                        </div>
                        <div class="container">
                            <div id="diseases_div">
                                <template is="dom-repeat" items="{{diseasesPRS}}">
                                    <template is="dom-if" if="{{item.samples}}">
                                        <label class="stv-control">
                                            <input type="checkbox" class="diseaseName" name="disease" id="disease{{item.groupId}}" value="{{item.groupId}}" checked on-click="updateDiseases"/>
                                            <span>{{item.name}}</span>
                                        </label>
                                    </template>
                                </template>
                            </div>
                        </div>
                    </stv-form-box>
                </form>
            </div>

            <div id="prsDiv" class="vertical layout">
                <div id=prsDivTable" class="horizontal layout  center-justified">
                    <csvs-table-prs id="prsTable" ></csvs-table-prs>
                </div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-prs-element',
        properties: {
            diseasesPRS: {
                type: Array,
                value: function() {
                    return [];
                }
            },
        },
        ready: function() {
            this.getDiseasesPRS();
        },

        getDiseasesPRS: function() {
            var me = this;
            CSVSManager.prs.diseases({
                request: {
                    async: false,
                    success: function(response) {
                        try {
                            var diseasesPRS = [];

                            var ibsPos = -1;
                            var mgpPos = -1;
                            var healthyPos = -1;

                            for (var i = 0; i < response.result.length; i++) {
                                var elem = response.result[i];
                                if (elem.name === "IBS (107 Spanish individuals from 1000genomes)") {
                                    ibsPos = i;
                                } else if (elem.name === "MGP (267 healthy controls)") {
                                    mgpPos = i;
                                } else if (elem.name === "Healthy controls") {
                                    healthyPos = i;
                                } else {
                                    diseasesPRS.push(elem);
                                }
                            }
                            if (healthyPos != -1) {
                                diseasesPRS.unshift(response.result[healthyPos]);
                            }
                            if (ibsPos != -1) {
                                diseasesPRS.unshift(response.result[ibsPos]);
                            }
                            if (mgpPos != -1) {
                                diseasesPRS.unshift(response.result[mgpPos]);
                            }

                            me.diseasesPRS = diseasesPRS;
                        } catch (err) {
                            console.log("Error loading diseasesPRS: " + err);
                            me.diseasesPRS = [];
                        }
                    },
                    error: function(response) {
                        console.log("ERROR downloading diseasesPRS");
                        console.log(response);
                    }
                }
            });
        },

        submitForm: function() {
            var me = this;
            var prsValue = this.$.filterPrs.$.filterPrs.checkPrs();

            var listPrs = prsValue != null ? prsValue.split(",") : [];
            for (var i = 0; i < listPrs.length; i++) {
                listPrs[i] = listPrs[i].trim();
            }
            var listPrs = listPrs.join(",");

            var newQuery = {"searchPrs": listPrs,
                             "adSources": this.$.filterPrs.$.filterPrs.getSelectedAncestry("sources").join(","),
                             "adListPgs": this.$.filterPrs.$.filterPrs.getSelectedAncestry("listPgs").join(","),
                             "adScores": this.$.filterPrs.$.filterPrs.getSelectedAncestry("scores").join(",")
                            };
            newQuery.limit = 10;
            this.$.prsTable.newQuery= newQuery;
        },

        clearForm: function() {
            this.$.filterPrs.reset();
            this.selectAllDiseases();
        },

        deselectAllDiseases: function(e, d, s) {
            var name = (e != undefined && e.target != undefined && e.target.getAttribute("name") == "CSVS") ? "diseaseNameCSVS": "diseaseName";
            var checkboxes = this.$.filter_prs_form.getElementsByClassName(name);
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
            this.updateDiseases();
        },
        selectAllDiseases: function(e, d, s) {
            var name = (e != undefined && e.target != undefined && e.target.getAttribute("name") == "CSVS") ? "diseaseNameCSVS": "diseaseName";
            var checkboxes = this.$.filter_prs_form.getElementsByClassName(name);
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }
            this.updateDiseases();
        },

        updateDiseases: function(){
            this.$.prsTable.$.prsGraphicElement.isLoading = true;
            this.$.prsTable.$.prsGraphicElement.diseases = this.getDiseases();
        },
        getDiseases: function() {
            var diseaseIds = [];
            var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
            for (var i = 0; i < diseaseEls.length; i++) {
                var el = diseaseEls[i];
                if (el.checked) {
                    diseaseIds.push(el.getAttribute("value"));
                }
            }
            return diseaseIds;
        }
    });
</script>
