<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<dom-module name="csvs-stats-element">
    <style is="custom-style"
           include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            width: 100%;
        }

        .selector_list {
            height: 200px;
        }

        .buttons_container {
            margin-top: 20px;
            margin-bottom: 50px;
        }

        .chartElement {
            margin-top: 200px;
            width: 1000px;
            background-color: red;
        }
        .chartContainerElement{
           // margin-top: 20px;
           // height: 600px;
           //width: 1000px;
            margin: 10px;
        }

    </style>
    <template>

        <div class="vertical layout center-justified">
            <div id="chartContainer" class="vertical layout center">
                <div id="variantsDiseaseContainer" class="chartContainerElement"></div>
                <div id="samplesDiseaseContainer" class="chartContainerElement"></div>
            </div>
            <div id="techChartContainer" class="horizontal layout center flex center-justified">
                <div id="variantsTechnologyContainer" class="chartContainerElement"></div>
                <div id="samplesTechnologyContainer" class="chartContainerElement"></div>
            </div>
            <div  class="horizontal layout center-justified">
                <div id="samplesMethylationContainer" class="chartContainerElement"></div>
                <div id="samplesTechMethylationContainer" class="chartContainerElement"></div>
            </div>
            <div  class="horizontal layout center-justified">
                <div id="samplesGendersMethylationContainer" class="chartContainerElement"></div>
                <div id="samplesTissueMethylationContainer" class="chartContainerElement"></div>
            </div>
            <div  class="horizontal layout center-justified">
                <div id="samplesAgeMethylationContainer" class="chartContainerElement"></div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-stats-element',
        properties: {
            diseases: {
                type: Array,
                value: function () {
                    return [];
                },
                observer: 'diseasesChanged'
            },
            technologies: {
                type: Array,
                value: function () {
                    return [];
                },
                observer: 'technologiesChanged'
            },
            methylationFilters: {
                type: Array,
                value: function () {
                    return [];
                },
                observer: 'methylationsChanged'
            },
            colors: {
                type: Array,
                value: [],
            },
        },
        created: function () {
        },

        ready: function () {
            this.colors = this.getColors();
            me = this;
        },

        diseasesChanged: function (oldValue, newValue) {
           let dataDiseases = this.diseases.
                              sort((a, b) => a.groupId - b.groupId);
                             // map(e => this.getChartData(e, dataProp))

           if (dataDiseases.length > 0 ){
                for (i = 22; i>= 0; i--){
                    dataDiseases = this.moveObject(dataDiseases, 'groupId', i+27, i+1);
                }
           }

           this._createPieChart( "Subpopulation", dataDiseases, this.$.variantsDiseaseContainer, "variants", "Subpopulation: variants");
           this._createPieChart( "Subpopulation", dataDiseases, this.$.samplesDiseaseContainer, "samples", "Subpopulation: samples");
        },

        technologiesChanged: function (oldValue, newValue) {
           this._createPieChart( "Technology", this.technologies, this.$.variantsTechnologyContainer, "variants", "Technology: variants");
           this._createPieChart( "Technology", this.technologies,  this.$.samplesTechnologyContainer, "samples","Technology: samples");
        },

        methylationsChanged: function (oldValue, newValue) {
            this._createPieChart( "Methylation", this.getDataMethylation("subpop"),  this.$.samplesMethylationContainer, "samples", "Methylation: samples per subpopulation");
            this._createPieChart( "Methylation", this.getDataMethylation("tech"), this.$.samplesTechMethylationContainer, "samples", "Methylation: samples per Technology");
            this._createPieChart( "Methylation", this.getDataMethylation("tissue"), this.$.samplesTissueMethylationContainer, "samples", "Methylation: samples per Tissue");
            this._createPieChart( "Methylation", this.getDataMethylation("gender"), this.$.samplesGendersMethylationContainer, "samples", "Methylation: samples per Gender");
            this._createPieChart( "Methylation", this.getDataMethylation("age"), this.$.samplesAgeMethylationContainer, "samples", "Methylation: samples per Age");
        },

        getDataMethylation: function(filter){
            return this.methylationFilters  != null ? this.methylationFilters.filter(f => f.filter == filter) : []
        },

        getColors: function(){
           let colors = [];
           let colorsInitial =[
              '#058DC7', '#50B432', '#ED561B', '#DDDF00', '#24CBE5', '#64E572','#FF9655', '#FFF263', '#6AF9C4',
           ];
           colors.push(...colorsInitial);
           for (j = 0; j <= colorsInitial.length; j++){
              colors.push(Highcharts.getOptions().colors[j]);
              for (i = 0; i<1 ; i++){
                colors.push(Highcharts.color(Highcharts.getOptions().colors[j]).brighten((i - 1) / 7).get());
               // colors.push(Highcharts.color(colorsInitial[j]).brighten((i - 1) / 7).get());
              }
          }
          return colors;
        },

        moveObject: function  (arr, targetKey, targetValue, newIndex) {
                const target = arr.find(value =>  value[targetKey] === targetValue)
                const newArray = arr.filter(value =>  value[targetKey] != targetValue)
                if (target != undefined){
                    newArray.splice(newIndex, 0, target);
                }
                return newArray;
        },
        getChartData: function(e, dataProp) {
            let d = Object.assign({}, e);
            d.y = e[dataProp];
            if (e.groupId <= 22) {
              d.color = this.colors[e.groupId-1];
            } else {
                if (e.groupId >= 27 && e.groupId <= 48) {
                    d.color = {
                                pattern : {
                                    "path": "M 0 0 L 5 5 M 4.5 -0.5 L 5.5 0.5 M -0.5 4.5 L 0.5 5.5",
                                    "color": this.colors[e.groupId-27],
                                    "width": 5,
                                    "height": 5,
                                },
                                color: "red"
                              } ;
                } else {
                     d.color = null;
                }
            }
            return d;
        },
        _createPieChart: function (nameElement, data, container, dataProp, title) {
            if (data != undefined && data != null && data.length > 0) {
                let dataGraphic = data.map(e => this.getChartData(e, dataProp));
                dataGraphic = dataGraphic.filter(e=> e.y != 0);

                if (dataGraphic.length > 0){
                    var vpp = new Highcharts.Chart(container,{
                        chart: {
                            plotBackgroundColor: null,
                            //plotBorderWidth: 1,//null,
                            //plotShadow: false,
                            borderRadius: 10,
                            //width: 1000,
                            width: nameElement == "Subpopulation" ? 1000 : null,
                            plotAreaHeight: 200,
                            height: nameElement == "Subpopulation" ? 750 : null,
                            marginTop:35,
                        },

                        title: {
                            text: title
                        },

                        plotOptions: {
                            pie: {
                                colors: this.colors.slice(22),
                                showInLegend: true,
                                allowPointSelect: true,
                                cursor: 'pointer',
                                shadow: false,
                                distance: '20%',
                                dataLabels: {
                                    useHTML:true,
                                    shadow: false,
                                    enabled: true,
        //                          format: '{point.name}: {point.y:,.0f}',
                                    style: {
                                            fontWeight: 'middle'
                                    },
                                    formatter: function () {
                                        var maxLength = 30;
                                        var res = this.point.name;
                                        var control = res.includes("(controls)")? "(controls)":"";
                                        if (res.length > maxLength) {
                                            var match = res.match(/[IVX]+ /g);
                                            if (match != null && match.length > 0)
                                                res = match + control ;
                                            else
                                              res = res.slice(0, maxLength) + '...'+ control ;
                                        }
                                        return  res + ': <b>' + this.point.y.toLocaleString() +'</b>';
                                    }
                                },
                            }
                        },
                        legend: {
                            y: -10,
                            verticalAlign: 'bottom',
                            //align: nameElement == "Subpopulation" ? 'center' : 'left',
                            align:  'center' ,
                            useHTML: true,
                            itemWidth:  480 ,
                            alignColumns: true,
                            //itemStyle : '{ "word-wrap": "break-word","textOverflow": "ellipsis","max-width":95%}',
                            itemStyle : { "word-wrap": "break-word","textOverflow": "ellipsis"},
                            labelFormatter: function () {
                                var maxLength =  40;
                                var res = this.name;
                                var control = res.includes("(controls)")? "(controls)":""
                                return '<div style="display: flex;" title="'+this.name +  ' : ' + this.y +  '"><div style="white-space: nowrap; max-width: 300px;overflow: hidden; text-overflow: ellipsis ">'+ res + "</div><div>: <b>"  +  this.y.toLocaleString()  + '</b></div></div>';
                            },
                        },
                        series: [{
                            type: "pie",
                            name: nameElement == "Methylation" && dataProp == "variants" ?  "positions" : dataProp ,
                            data: dataGraphic,
                        }]
                    });
                }
            }
        },

        _formatText: function (text) {
            if (text) {
                return stv.utils.formatText(text, "_").toLowerCase().replace(/(?:^|\s)\S/g, function (a) {
                    return a.toUpperCase();
                });
            } else {
                return "";
            }
        }
    });
</script>
