<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<dom-module name="csvs-stats-element">
    <style is="custom-style"
           include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            width: 100%;
        }

        .selector_list {
            height: 200px;
        }

        .buttons_container {
            margin-top: 20px;
            margin-bottom: 50px;
        }

        .chartElement {
            margin-top: 200px;
            width: 1000px;
            background-color: red;
        }
        .chartContainerElement{
            margin-top: 20px;
           // height: 600px;
           //width: 1000px;
        }

    </style>
    <template>
        <div class="vertical layout center-justified">
            <div id="chartContainer" class="vertical layout center">
                <div id="variantsDiseaseContainer" class="chartContainerElement"></div>
                <div id="samplesDiseaseContainer" class="chartContainerElement"></div>
            </div>
            <div id="techChartContainer" class="vertical layout center">
                <div id="variantsTechnologyContainer" class="chartContainerElement"></div>
                <div id="samplesTechnologyContainer" class="chartContainerElement"></div>
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-stats-element',
        properties: {
            diseases: {
                type: Array,
                value: function () {
                    return [];
                },
                observer: 'diseasesChanged'
            },
            technologies: {
                type: Array,
                value: function () {
                    return [];
                },
                observer: 'technologiesChanged'
            }
        },
        created: function () {
        },
        ready: function () {
        },
        diseasesChanged: function (oldValue, newValue) {
           this.statsPerDisease();
        },
        technologiesChanged: function (oldValue, newValue){
           this.statsPerTechnology();
        },
        _createPieChart: function (container, text, data, containerText) {

            let colorsInitial =[
                   '#058DC7', '#50B432', '#ED561B', '#DDDF00', '#24CBE5', '#64E572','#FF9655', '#FFF263', '#6AF9C4',
                  ];

            let colors = [];
            colors.push(...colorsInitial);
            for (j=0; j<= colorsInitial.length; j++){
              colors.push(Highcharts.getOptions().colors[j]);
              for (i=0;i<1; i++){
                colors.push(Highcharts.color(Highcharts.getOptions().colors[j]).brighten((i - 1) / 7).get());
                colors.push(Highcharts.color(colorsInitial[j]).brighten((i - 1) / 7).get());
              }
            }

            var vpp = new Highcharts.Chart(container,{
                chart: {
                    plotBackgroundColor: null,
                    //plotBorderWidth: 1,//null,
                    //plotShadow: false,
                    borderRadius: 10,
                    width: 1000,
                    plotAreaHeight: 200,
                    height: containerText == "Disease" ? 700 : 400,
                    marginTop:35,
                },

                title: {
                    text: text
                },

                plotOptions: {
                    pie: {
                        colors: colors,
                        showInLegend: true,
                        allowPointSelect: true,
                        cursor: 'pointer',
                        shadow: false,
                        distance: '20%',
                        dataLabels: {
                            useHTML:true,
                            shadow: false,
                            enabled: true,
//                          format: '{point.name}: {point.y:,.0f}',
                            formatter: function () {
                                var maxLength = 30;
                                var res = this.point.name;
                                var control = res.includes("(controls)")? "(controls)":"";
                                if (res.length > maxLength) {
                                    var match = res.match(/[IVX]+ /g);
                                    if (match != null && match.length > 0)
                                        res = match + control ;
                                    else
                                      res = res.slice(0, maxLength) + '...'+ control ;
                                }
                                return  res + ': ' + this.point.y ;
                            }
                        },
                    }
                },
                legend: {
                    y: -10,
                    verticalAlign: 'bottom',
                    align: containerText == "Disease" ? 'center' : 'left',
                    useHTML: true,
                    itemWidth: containerText == "Disease" ? 480 : 100,
                    alignColumns: true,
                    //itemStyle : '{ "word-wrap": "break-word","textOverflow": "ellipsis","max-width":95%}',
                    itemStyle : { "word-wrap": "break-word","textOverflow": "ellipsis"},
                    labelFormatter: function () {
                        var maxLength =  60;
                        var res = this.name;
                        var control = res.includes("(controls)")? "(controls)":""
                        return '<div title="'+this.name +  ' : ' + this.y +  '" style="white-space: nowrap; width: 350px;overflow: hidden; text-overflow: ellipsis ">'+ res + ": "  +  this.y + ' </div>';
                    },
                },
                series: [{
                    type: 'pie',
                    name: text,
                    data: data,

                }]
            });
        },

        statsPerDisease: function () {
            var auxVariants = {};
            var auxSamples = {};
            var variants = [];
            var samples = [];
            if (this.diseases != null) {
                for (var i = 0; i < this.diseases.length; i++) {
                    var disease = this.diseases[i];
                    var name = disease.name;

                    if (!(name in auxVariants)) {
                        auxVariants[name] = 0;
                        auxSamples[name] = 0;
                    }

                    auxVariants[name] += disease.variants;
                    auxSamples[name] += disease.samples;
                }
            }
            Object.keys(auxVariants).forEach(function (key) {
                if (auxSamples[key] > 0) {
                    variants.push({
                        name: key,
                        y: auxVariants[key]
                    })
                }
            });

            Object.keys(auxSamples).forEach(function (key) {
                if (auxSamples[key] > 0) {
                    samples.push({
                        name: key,
                        y: auxSamples[key]
                    })
                }
            });

            if (variants.length > 0 || samples.length > 0){
                try {
                    this._createPieChart(this.$.variantsDiseaseContainer, "Variants per Disease" , variants, "Disease");
                    this._createPieChart(this.$.samplesDiseaseContainer, "Samples per Disease", samples, "Disease");
                } catch(e){
                    console.log(e);
                }
            }

        },

        statsPerTechnology: function () {
            var auxVariants = {};
            var auxSamples = {};
            var variants = [];
            var samples = [];
            if (this.technologies != null){
                for (var i = 0; i < this.technologies.length; i++) {

                    var technology = this.technologies[i];
                    var name = technology.name;

                    if (!(name in auxVariants)) {
                        auxVariants[name] = 0;
                        auxSamples[name] = 0;
                    }

                    auxVariants[name] += technology.variants;
                    auxSamples[name] += technology.samples;
                }
            }

            Object.keys(auxVariants).forEach(function (key) {
                if (auxSamples[key] > 0) {
                    variants.push({
                        name: key,
                        y: auxVariants[key]
                    })
                }
            });

            Object.keys(auxSamples).forEach(function (key) {
                if (auxSamples[key] > 0) {
                    samples.push({
                        name: key,
                        y: auxSamples[key]
                    })
                }
            });

            if (variants.length > 0 || samples.length > 0){
                try {
                    this._createPieChart(this.$.variantsTechnologyContainer, "Variants per Technology" , variants, "Technology");
                    this._createPieChart(this.$.samplesTechnologyContainer, "Samples per Technology", samples, "Technology");
                } catch(e){
                    console.log(e);
                }

            }
        },

        _formatText: function (text) {
            if (text) {

                return stv.utils.formatText(text, "_").toLowerCase().replace(/(?:^|\s)\S/g, function (a) {
                    return a.toUpperCase();
                });
            } else {
                return "";
            }

        }
    });
</script>
