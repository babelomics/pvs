<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="../bower_components/jsorolla/src/lib/components/jso-genome-viewer-element.html">

<link rel="import" href="../bower_components/stevia-elements/src/filter/stv-filter-position.html">
<link rel="import" href="./csvs-filter-consequencetypes.html">
<link rel="import" href="../bower_components/stevia-elements/src/stv-tooltip.html">

<script src="../bower_components/stevia-elements/src/manager/cellbase-manager.js"></script>
<script src="./manager/csvs-manager.js"></script>
<script src="./manager/ws-manager.js"></script>

<link rel="import" href="./csvs-table-saturation.html">

<link rel="import" href="csvs-saturation-element.html">


<link rel="import" href="csvs-contact-request.html">

<link rel="import" href="csvs-pathopedia.html">
<link rel="import" href="./methylation/csvs-methylation-graphic-element.html">
<script src="./variant/csvs-search-columns.js"></script>
<script src="./variant/csvs-search-parse.js"></script>

<dom-module id="csvs-search-element">
    <style is="custom-style" include="iron-flex iron-flex-reverse iron-flex-alignment iron-flex-factors iron-positioning">
        :host {
            display: block;
            box-sizing: border-box;
            position: relative;
            background-color: var(--text-primary-color);
            color: var(--primary-text-color);
        }

        #filter-form-element {
            background-color: #FFFFFF;
            width: 250px;
            margin: 20px;
            min-height: 900px;
        }

        textarea {
            resize: none;
        }

        .searchGene {
            margin-top: 5px;
        }

        #dataGridElement {
            border-radius: 0px !important;
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 290px);
            min-width: 300px;
        }

        #saturationDiv, .saturatDiv {
            margin: 20px 20px 20px 0px;
            background-color: #FFFFFF;
            width: calc(100% - 29em);
            padding: 0em 4em;
        }

        .container> span {
            margin-left: 10px;
        }

        .stv-form-box {
            width: 250px;
            ;
        }

        #diseases_div
        {
            height: 300px;
            max-height: 300px;
            overflow-y: auto;
        }

        #technologies_div {
            height: 50px;
            max-height: 50px;
            width: 225px;
            overflow-y: auto;
        }
        #highlights_div{
            height: 550px;
            max-height: 550px;
            width: 225px;
            overflow-y: auto;
        }

        #exportBtn {
            height: 20px;
        }

        #dataTable {
            font-size: 11px;
        }

        stv-table {
            overflow-y: auto;
        }

        stv-table::shadow #list {
            height: 300px;
            overflow-x: auto
        }

        stv-table::shadow {
            font-size: 11px;
        }

        #menu {
            margin-top: 15px;
        }

        #menu> div {
            font-size: 17px;
            padding: 5px 5px;
            margin: 0 20px;
            border-bottom: 2px solid transparent;
            transition: all 0.1s;
            cursor: pointer;
        }

        #menu> div:hover {
            border-bottom-color: rgba(125, 125, 125, 0.4);
        }

        #menu> div[selected] {
            border-bottom-color: rgba(125, 125, 125, 0.7);
        }

        #tools {
            margin-top: 10px;
        }

        .tool {
            min-height: 1000px;
            width: 100%;
        }

        jso-genome-viewer-element,
        #dataTable {
            box-shadow: 0px 0px 2px 0px rgba(0, 0, 0, 0.2);
        }

        stv-form-box {
            min-width: 240px;
        }

        #dataTable {
            border: 1px solid var(--divider-color)
        }

        stv-tooltip::shadow #messageInfo::shadow {
            height: 300px;
            width: 500px;
            background-color: #e2e9e9;
            border: 1px solid #e2e9e9;
            color: black;
            font-style: normal;
        }

        stv-tooltip::shadow .closeInfo::shadow {
            margin-left: 490px;
        }

        .tit {
            margin-top: 10px;
            border-bottom: 1px solid #445D76;
            font-weight: bold;
        }

        .name {
            width: 300px;
        }

        .num {
            width: 100px;
        }

        .clear-but {
            width: 100px;
            background-color: #f0f4f4 !important;
        }

        #filterHistoryTable> div:hover {
            background-color: #8ba7a7;
            border: 1px solid #8ba7a7;
        }

        #filter-name {
            text-overflow: ellipsis;
            width: 300px;
            white-space: nowrap;
            overflow: hidden;
        }

        .check {
            cursor: pointer;
            color: var(--secondary-text-color);
            padding-right: 2px;
        }

        .check:hover {
            color: var(--accent-color);
            font-weight: bold;
        }

        .titleCategory{
            background-color: #f0f0f0;
        }
    </style>
    <template>
        <div class="horizontal layout">
            <div id="filter-form-element">
                <form id="filter_form" class="vertical layout">
                    <div class="vertical layout">
                        <div id="buttons_container" class="horizontal layout end-justified" style="margin:10px 5px;">
                            <!-- <stv-tooltip id="filterHistoryTooltip" class="stv-btn stv-btn-shdw" title="Filters History" icon="filter" style="margin-right: 3px;">
                                <div class="stv-btn stv-btn-shdw clear-but" title="Clear Filters History" on-click="clearFiltersHistory">
                                    Clear
                                </div>
                                <div class="horizontal layout flex">
                                    <span class="tit num"> Date </span>
                                    <span class="name tit"> Name </span>
                                    <span class="tit num"> Found</span>
                                </div>
                                <div id="filterHistoryTable">
                                    <template is="dom-repeat" items="{{historyFilters}}">
                                        <div class="horizontal layout flex" on-click="loadFilter" data-filter="{{item.filter}}" title="{{item.name}}">
                                            <span class="num">{{item.date}} </span>
                                            <span id="filter-name" class="name">{{item.name}} </span>
                                            <span class="num">{{item.found}}</span>
                                        </div>
                                    </template>
                                </div>
                            </stv-tooltip> -->
                            <div class="stv-btn stv-btn-shdw flex" on-click="clearForm" style="margin-right: 3px;">
                                Clear
                            </div>
                            <div class="stv-btn stv-btn-shdw flex" on-click="submitForm">Search</div>
                        </div>

                        <stv-filter-position id="filterPosition"></stv-filter-position>
                        <stv-form-box>
                            <div class="header horizontal layout flex">
                                <div>Subpopulations</div>
                                <div class="flex"></div>
                                <div on-click="selectAllDiseases" title="Select all subpopulations">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllDiseases" title="Deselect all subpopulations">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="diseases_div">
                                    <template is="dom-repeat" items="{{diseases}}">
                                        <template is="dom-if" if="{{item.samples}}">
                                            <label class="stv-control">
                                                <input type="checkbox" class="diseaseName" name="disease" id="disease{{item.groupId}}" value="{{item.groupId}}" checked/>
                                                <span>{{item.name}}</span>
                                            </label>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </stv-form-box>
                        <stv-form-box>
                            <div class="header horizontal layout flex">
                                <div>Technologies</div>
                                <div class="flex"></div>
                                <div on-click="selectAllTechnologies" title="Deselect all technologies">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllTechnologies" title="Select all technologies">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="technologies_div">
                                    <template is="dom-repeat" items="{{technologies}}">
                                        <template is="dom-if" if="{{item.samples}}">
                                            <label class="stv-control">
                                                <input type="checkbox" class="technologyName" name="technology" id="technology{{item.technologyId}}" value="{{item.technologyId}}" checked/>
                                                <span>{{item.name}}</span>
                                            </label>
                                        </template>
                                    </template>
                                </div>
                            </div>
                        </stv-form-box>
                        <stv-form-box hidden$="{{saturation}}">
                            <div class="header horizontal layout flex">
                                <div>Highlights</div>
                                <div class="flex"></div>
                                <div on-click="selectAllHighlights" title="Select all Sequence Ontology terms">
                                    <i class="fa fa-check-square-o check"></i>
                                </div>
                                <div on-click="deselectAllHighlights" title="Deselect all Sequence Ontology terms">
                                    <i class="fa fa-square-o check"></i>
                                </div>
                            </div>
                            <div class="container">
                                <div id="highlights_div">
                                    <template is="dom-repeat" items="{{highlights}}" as="highlightGroup">
                                        <div>
                                            <label class="stv-control">
                                                <label class="stv"><span>{{highlightGroup.group}}:</span></label>
                                                <template is="dom-repeat" items="{{highlightGroup.groupValues}}" as="item">
                                                    <div style="padding-left: 15px; display:inline-block">
                                                        <span style="display:inline-block; width: 70px" title="{{item.description}}">{{item.title}} <sup><i class="fa fa-info-circle" style="color:#666" aria-hidden="true"></i></sup>:</span>
                                                        <select class="highlightsOp stv stv-btn" style="display:inline-flex;"
                                                                name="highlightOp" id="opc_{{item.name}}" key="{{item.name}}" value="{{item.op}}"  />
                                                        <template is="dom-repeat" items="{{item.ops}}" as="itemOp">
                                                            <option value="{{itemOp}}"> {{itemOp}} </option>
                                                        </template>
                                                        </select>
                                                        <input type="text" class="highlightsName stv" style="width: auto; display:inline" label="{{item.title}}"
                                                               name="highlight"  id="highlight_{{item.name}}" key="{{item.name}}" value="{{item.value}}" size="5" min="{{item.limit.min}}" max="{{item.limit.max}}"
                                                               inputmode="numeric" pattern="-?(0|([1-9]\d*))(\.\d+)?"
                                                        />
                                                    </div>
                                                </template>
                                            </label>
                                        </div>
                                    </template>

                                    <div>
                                        <csvs-consequencetypes id="highlightsConsequenceTypes" ></csvs-consequencetypes>
                                    </div>

                                </div>
                            </div>
                        </stv-form-box>


                    </div>
                </form>
            </div>
            <div id="dataGridElement" class="vertical layout" hidden$="{{saturation}}">
                <stv-table id="dataTable" enable-loading enable-paging enable-remote enable-select enable-resize request="{{request}}" columns="{{columns}}" on-rowclick="handleRowClick">
                    <div class="custom-buttons horizontal layout">
                        <button style="margin-right: 10px; color: #006699" id="saveTable" class="stv-btn down" on-click="downloadFiles" data-file="{{cnv}}"><i class="fa fa-cloud-download"></i> save</button>
                    </div>
                </stv-table>

                <div id="menu" class="color-2 color-hover-2 horizontal layout">
                    <div on-click="handleMenuClick" data-option="gv">Genomic context</div>
                    <div on-click="handleMenuClick" data-option="frequency">Frequencies</div>
                    <div on-click="handleMenuClick" data-option="phenotype">Phenotype</div>
                    <div on-click="handleMenuClick" data-option="effect">Effect</div>
                    <div on-click="handleMenuClick" data-option="pharmacogenomic">PGx</div>
                    <div on-click="handleMenuClick" data-option="methylation">Methylation</div>
                </div>

                <div id="tools" class="horizontal layout flex">

                    <jso-genome-viewer-element id="gv" class="tool" on-created="handleGenomeViewerCreated"></jso-genome-viewer-element>
                    <stv-variant-frequencies id="frequency" hidden class="tool"></stv-variant-frequencies>
                    <stv-variant-phenotype id="phenotype" hidden class="tool"></stv-variant-phenotype>
                    <stv-variant-effect id="effect" hidden class="tool"></stv-variant-effect>
                    <csvs-variant-pharmacogenomic id="pharmacogenomic" hidden class="tool"></csvs-variant-pharmacogenomic>
                    <csvs-methylation-graphic-element id="methylation"  hidden  class="tool"></csvs-methylation-graphic-element>
                </div>
            </div>
            <div id="saturationDiv" hidden$="{{!saturation}}" class="vertical layout">
                <div id="chart" class="horizontal layout center-justified"  >
                </div>
                <div id=saturationDivTable" class="horizontal layout flex center-justified">
                    <csvs-table-saturation id="tvSaturation" ></csvs-table-saturation>
                </div>
            </div>
        </div>

    </template>
</dom-module>
<script>
    Polymer({
        is: 'csvs-search-element',
        properties: {
            diseases: {
                type: Array,
                value: function() {
                    return [];
                },
                observer: 'diseasesChanged'
            },
            technologies: {
                type: Array,
                value: function() {
                    return [];
                }
            },
            highlights: {
                type: Array,
                value: function () {
                    return CSVSSearchColumns.highlights;
                }
            },
            highlightsSO: {
                type: Object,
                value: function() {
                    return CSVSSearchColumns.highlightsSO;
                },
            },
            regionValue: {
                type: String,
                value: ""
            },
            columns: {
                type: Array,
                value: function() {
                    return [];
                },
            },
            formURL: {
                type: String,
                value: "",
                observer: 'urlChanged'
            },
            floatDecimals: {
                type: Number,
                value: 3
            },

            selectedMenuTool: {
                type: Object,
                observer: 'selectedMenuChanged'
            },
            geneValue: {
                type: String,
                value: ""
            },
            hidden: {
                type: Boolean,
                reflectToAttribute: true,
                observer: 'hiddenChanged',
                nofity: true
            },
            maxLength: {
                type: Number,
                value: 1000000
            },
            isLogged: {
                type: Boolean
            },
            historyFilters: {
                type: Array,
                value: function() {
                    return [];
                },
                notify: true,

            },
            numTotalResults: {
                type: Object,
                observer: "resultsChanged"
            },
            query: {
                type: Object,
                notify: true,
                value: function() {
                    return {};
                }
            },
            saturation: {
                type: Boolean,
                value: false,
                observer: "saturationChanged"
            },
            loadingSaturation:{
                type: Boolean,
                value: false
            }
        },
        listeners: {  // when open popup
            "disablescroll": 'disableScroll',
            "enablescroll": 'enableScroll',
            "getDataSearch": 'getDataSearch'
        },

        saturationChanged: function(){
            // Check if tab is changed and reload info
            this.submitForm();
        },
        resultsChanged: function(neo, old) {
            return;
            if (neo != -1) {
                var query = this.query;
                var numTotalResults = neo;
                /* Filter History */

                var newFilter = JSON.stringify(query);
                var _load = -1;
                for (var i = 0; i < this.historyFilters.length && _load == -1; i++) { // Check if the fitler has been selected from the history
                    var elem = this.historyFilters[i];
                    if (elem != null) {
                        var oldFilter = JSON.stringify(this.historyFilters[i].filter);
                        if (newFilter == oldFilter) {
                            _load = i;
                        }
                    }
                }

                if (_load == -1) { // This filter is new (has not been selected from the history)
                    if (query.regions != null && query.diseases != null) {
                        var dateAux = new Date();
                        var minAux = dateAux.getMinutes();
                        if (minAux < 10) {
                            minAux = "0" + minAux;
                        }
                        var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;
                        name = this.loadForm(query);
                        var found = numTotalResults;
                        var hf = {};
                        hf = {
                            date: date,
                            name: name,
                            filter: query,
                            found: found
                        };

                        var filters = new FilterHistory(5, this.historyFilters);
                        filters.unshift(hf);
                        this.set("historyFilters", filters);

                        localStorage.csvs_filter_history = JSON.stringify(this.historyFilters);
                    }
                } else { // HistoryFilter contains this filter. We need to change the date and push to top
                    var pos = _load;

                    var filters = new FilterHistory(5, this.historyFilters);
                    var filter = filters[pos];
                    var dateAux = new Date();
                    var minAux = dateAux.getMinutes();
                    if (minAux < 10) {
                        minAux = "0" + minAux;
                    }
                    var date = dateAux.getDate() + '/' + (dateAux.getMonth() + 1) + ' ' + dateAux.getHours() + ':' + minAux;

                    filter.date = date;

                    var aux = filters[pos];
                    filters[pos] = filters[0];
                    filters[0] = aux;

                    this.set("historyFilters", filters);
                    localStorage.csvs_filter_history = JSON.stringify(this.historyFilters);
                }
            }

        },

        geneChanged: function(e) {
            var target = e.currentTarget;
            var value = target.value;
            var splits = value.split(",");
            if (splits.length > 3 && !this.isLogged) {
                new StvDialog().alert("The maximum number of genes is 3");
            }
        },
        hiddenChanged: function(neo, old) {

            if (!neo && this.selectedMenuTool) {
                this.$.gv.removeAttribute("hidden");
            }
        },
        created: function() {
            this.selectedSpecies = DEFAULT_SPECIES;
        },


        handleHighlights: function(){
            var msj = "";
            var highlightsNameValue = this.$.highlights_div.querySelectorAll(".highlightsName");
            var highlightsOpValue = this.$.highlights_div.querySelectorAll(".highlightsOp");

            var  pos = 0;
            for (var i = 0; i < this.highlights.length && highlightsNameValue.length ; i++) {
                for (var j = 0; j < this.highlights[i].groupValues.length ; j++) {
                        if (highlightsNameValue[pos].value !=""){
                            if (!/^-?\d{1,9}(\.\d{1,2})?$/.test(highlightsNameValue[pos].value)) {
                                msj = msj + "Format incorrect: '" +  this.highlights[i].groupValues[j].title + " " +  highlightsOpValue[pos].value + " " + highlightsNameValue[pos].value + "'\n";
                            } else {
                                if (!!this.highlights[i].groupValues[j].limit)
                                    if ((this.highlights[i].groupValues[j].limit.min != undefined && this.highlights[i].groupValues[j].limit.min > parseFloat(highlightsNameValue[pos].value)) ||
                                        (this.highlights[i].groupValues[j].limit.max != undefined  && this.highlights[i].groupValues[j].limit.max < parseFloat(highlightsNameValue[pos].value)))
                                        {
                                            msj = msj + "Out of range in '" + this.highlights[i].groupValues[j].title + " " +  highlightsOpValue[pos].value + " " + highlightsNameValue[pos].value + "'"
                                                + ": Allowed values are between '"+this.highlights[i].groupValues[j].limit.min+"' and '"+this.highlights[i].groupValues[j].limit.max+"'\n";
                                        }
                            }
                        }

                        this.highlights[i].groupValues[j].value = highlightsNameValue[pos].value;
                        this.highlights[i].groupValues[j].op = highlightsOpValue[pos].value;
                        pos++;
                }
            }
            if (msj != ""){
                new StvDialog().alert("Highlights: \n" + msj);
                return
            }

            var highlightsSOChecked = this.$.highlights_div.querySelectorAll(".highlightSOName");

            highlightsSOChecked.forEach(
                hc =>{

                for (var i = 0; i < this.highlightsSO.groupValues.length; i++) {
                obj = this.highlightsSO.groupValues[i].ops.find(h => h.name === hc.value) ;
                    if (!!obj ) {
                        obj.checked = hc.checked;
            }
                }
            })



            return true;
        },

        highlightsDefault: function(){
            var highlightsNameValue = this.$.highlights_div.querySelectorAll(".highlightsName");
            var highlightsOpValue = this.$.highlights_div.querySelectorAll(".highlightsOp");

            var  pos = 0;
            for (var i = 0; i < this.highlights.length ; i++) {
                for (var j = 0; j < this.highlights[i].groupValues.length ; j++) {
                    highlightsNameValue[pos].value = this.highlights[i].groupValues[j].defaultValue;
                    highlightsOpValue[pos].value = this.highlights[i].groupValues[j].defaultOp;
                    pos++;
                }
            }

            var highlightsSOChecked = this.$.highlights_div.querySelectorAll(".highlightSOName");

            var pos = 0
            for (var i = 0; i < this.highlightsSO.groupValues.length ; i++) {
                for (var j = 0; j < this.highlightsSO.groupValues[i].ops.length ; j++) {
                    highlightsSOChecked[pos].checked = this.highlightsSO.groupValues[i].ops[j].defaultChecked;
                    //console.log(this.highlightsSO.groupValues[i].ops[j].defaultChecked, this.highlightsSO.groupValues[i].ops[j].name);
                    pos++;
                }

            }

        },

        initTitleMenu: function() {
            var list = document.getElementById('columnsMenu') != null ? document.getElementById('columnsMenu').getElementsByTagName("span") : [];
            // Num colums to modify
            var num_search = 2;
            for (var i = list.length-1; i>0 && num_search>0; i--) {
                var title = list[i].innerText;
                if (title.indexOf('Address') != -1) {
                    list[i].innerText = "Address Book";
                    num_search --;
                }
            }
        },

        ready: function() {
            if (localStorage.csvs_filter_history) {
                this.historyFilters = JSON.parse(localStorage.csvs_filter_history);

            }

            var me = this;
            this.species = 'Homo sapiens';
            var lastQuery = '';
            this.geneValue = "PPL";


            this.async(function () { // DOM READY
                me.selectedMenuTool = me.$.menu.querySelector('div');
                me.$.gv.createGenomeViewer();
                // remove block SNP
                //me.$.gv.genomeViewer.removeTrack(snpTrack);
                me.$.gv.genomeViewer.draw();

                this.initTitleMenu();
            }, 1000);

            // Load region from request
            if (window.location.search != "" && window.location.search.includes("?regions=")) {
                this.$.filterPosition.load({
                    region: window.location.search.replace("?regions=","")
                });
                // Search
                this.submitForm();
            }

            this.columns = [...CSVSSearchColumns.columns];
            this.reloadChart({});
        },
        downloadFiles: function(e) {
            //this.query.limit = 0;
            var newQuery = this.query;
            newQuery.skip=(this.$.dataTable.currentPage -1) * this.$.dataTable.pageSize;
            newQuery.enableSkip=true;

            var me = this;
            var url = CSVSManager.variants.fetch({
                query: newQuery,
                request: {
                    success: function(r) {
                        var stringToSave = "Chr"+ "\t"+"Position"+ "\t"+"alleles"+ "\t"+"0/0"+ "\t"+"0/1"+ "\t"+"1/1"
                                + "\t"+"./,"+ "\t"+"0Freq"+ "\t"+ "1Freq"+ "\t"+ "MAF"+"\n";

                        if (!!window.CSVS_LIMIT_MAX && r.numTotalResults > window.CSVS_LIMIT_MAX)
                            new StvDialog().alert('Only a maximum of '+ CSVS_LIMIT_MAX + ' variants is downloaded.');

                        for( var i = 0; i < r.result.length; i++){
                            stringToSave = stringToSave + me._csvToString(r.result[i]);
                        }
                        var blob = new Blob([stringToSave], {
                            type: "text/plain;charset=utf-8"
                        });
                        saveAs(blob, "csvs.txt");
                    },
                    error:function(r){
                        console.log("error in save");
                    }
                },
            });
        },
        _csvToString: function(o){
            return  "chr" + o.chromosome + "\t" + o.position + "\t" + o.reference + ">" + o.alternate +
                    "\t" + o.stats.gt00 + "\t" + o.stats.gt01 + "\t" + o.stats.gt11 +"\t" +
                    o.stats.gtmissing + "\t" + o.stats.refFreq + "\t" + o.stats.altFreq + "\t"+ o.stats.maf +"\n";
        },
        _toFixed: function(value, precision) {
            return Number(value).toFixed(precision);
        },
        _setQuickSearchMenu: function(query) {

            while (this.$.searchDataList.firstChild) {
                this.$.searchDataList.removeChild(this.$.searchDataList.firstChild);
            }
            this.quickSearchDataset = {};
            var items = this._quickSearchResultFn(query);
            for (var i = 0; i < items.length; i++) {
                var item = items[i];
                var value = item["name"];
                this.quickSearchDataset[value] = item;
                var menuEntry = document.createElement('option');
                menuEntry.setAttribute('value', value);
                this.$.searchDataList.appendChild(menuEntry);
            }

        },
        _quickSearchResultFn: function(query) {
            var results = [];
            var speciesCode = stv.utils.getSpeciesCode(this.species);

            CellBaseManager.get({
                host: CELLBASE_HOST,
                version: CELLBASE_VERSION,
                species: speciesCode,
                category: 'feature',
                subCategory: 'id',
                query: query,
                resource: 'starts_with',
                params: {
                    limit: 10
                },
                async: false,
                success: function(data, textStatus, jqXHR) {
                    results = data.response[0].result;
                }
            });
            return results;
        },
        submitForm: function(e) {
            if (!!this.$.frequency) {
                this.$.frequency.isEmpty = true;
            }
            if (!!this.$.phenotype){
                this.$.phenotype.isCosmicEmpty = true;
                this.$.phenotype.isGwasEmpty = true;
                this.$.phenotype.isClinvarEmpty = true;
            }
            if (!!this.$.effect)
                this.$.effect.isEmpty = true;

            if (!!this.$.pharmacogenomic)
                this.$.pharmacogenomic.isEmpty = true;

            if (!!this.$.methylation)
                this.$.methylation.isEmpty = true;

            var me = this;
            var query = {};
            var regionValue = this.$.filterPosition.checkRegion();
            if (regionValue == -1) {
                return;
            }

            var geneValue = this.$.filterPosition.checkGene();


            var regions = [];
            if (regionValue != null) {
                regions = regionValue.split(",");
                if (regions.length > this.maxLength && !this.isLogged) {
                    new StvDialog().alert("The total size of all provided regions can't exceed " + this.maxLength + " positions");
                    return
                }
            }

            if (!this.saturation && !this.handleHighlights())
                return

            var genes = [];
            if (geneValue != null) {

                genes = geneValue.split(",");
                for (var i = 0; i < genes.length; i++) {
                    genes[i] = genes[i].trim();
                }

                if (genes.length > 5 && !this.isLogged) {
                    new StvDialog().alert("The maximum number of genes is 5");
                    return;
                }

                var gene = genes.join(",").toUpperCase();

                var regionGene = {};

                CellBaseManager.get({
                    species: 'hsapiens',
                    category: 'feature',
                    subCategory: 'gene',
                    query: gene,
                    resource: "info",
                    async: false,
                    params: {
                        include: 'chromosome,start,end'
                    },
                    success: function(data) {
                        for (var i = 0; i < data.response.length; i++) {
                            var queryResult = data.response[i];

                            if (queryResult.result.length > 0) {
                                var region = new Region(queryResult.result[0]);
                                regionGene[region] = queryResult.id;
                                regions.push(region.toString());

                            } else {
                                new StvDialog().alert("Wrong gene: " + gene);
                            }
                        }
                    }
                });
            }

            var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
            var diseaseIds = [];


            for (var i = 0; i < diseaseEls.length; i++) {
                var el = diseaseEls[i];
                if (el.checked) {
                    diseaseIds.push(el.getAttribute("value"));
                }
            }

            var technologyEls = this.$.technologies_div.querySelectorAll(".technologyName");
            var technologyIds = [];

            for (var i = 0; i < technologyEls.length; i++) {
                var el = technologyEls[i];
                if (el.checked) {
                    technologyIds.push(el.getAttribute("value"));
                }
            }

            if (regions.length > 0) {
                var regionQuery = regions.join(",");
                query.regions = regionQuery;
                query.diseases = diseaseIds.join(",");
                query.technologies = technologyIds.join(",");
                query.skipCount = false;

                // Select tab saturation
                if (this.saturation){
                    // show msj loading
                    this.loadingSaturation = true;
                    // remove data chart
                    this.reloadChart({});
                    CSVSManager.regions.saturation({
                        id: regionQuery,
                        query: query,
                        request: {
                            success: function(response) {
                                var data = response.result[0];

                                for (var region in regionGene) {
                                    if (data != undefined && region in data) {
                                        var newKey = regionGene[region];
                                        data[newKey] = data[region];
                                        delete data[region];
                                    }
                                }
                                try {
                                    me.reloadChart(data);
                                    // remove msj loading
                                    me.loadingSaturation = false;
                                } catch (e) {
                                    me.reloadChart({});
                                    // remove msj loading
                                    me.loadingSaturation = false
                                }
                            },
                            error: function(response){
                                console.log(response);
                            }
                        }
                    });
                } else {
                    // Select tab saturation search
                    var url = CSVSManager.variants.fetch({
                        query: query,
                        request: {
                            url: true
                        }
                    });

                    // url == formURl no search but reload data
                    if (url == this.formURL){
                        this.urlChanged(url, this.formURL);
                    }

                    this.formURL = url;
                }
            }
            // e -> If event is click check region/gene
            if (regions.length == 0 && genes.length == 0 && e != undefined) {
                new StvDialog().alert("Please add a region/gene and check any subpopulation/technology");
            }

            query.gene = geneValue;
            this.set('query', query);

        },
        _formatText: function(text) {
            return stv.utils.formatText(text, "_").toLowerCase().replace(/(?:^|\s)\S/g, function(a) {
                return a.toUpperCase();
            });
        },
        clearForm: function() {

            this.$.filter_form.reset();
            this.$.filterPosition.clear();
            this.highlightsDefault();
        },
        loadForm: function(hf) {
            var filterName = [];
            var hfAux = hf;
            if (hf.regions != "" && hf.regions != null) {
                hfAux.region = hf.regions;
            }
            var fP = this.$.filterPosition.load(hfAux);
            if (fP.length > 0) {
                for (var i = 0; i < fP.length; i++) {
                    filterName.push(fP[i]);
                }
            }

            if (hf.diseases != "" && hf.diseases != null) {
                var disName = [];
                var dis = hf.diseases.split(",");
                var aux = this.$.diseases_div.querySelectorAll("input");
                for (var i = 0; i < aux.length; i++) {
                    aux[i].checked = false;
                }
                for (var i = 0; i < dis.length; i++) {
                    for (var j = 0; j < aux.length; j++) {
                        var id = aux[j].value;
                        if (dis[i] == id) {
                            aux[j].checked = true;
                            for (var k = 0; k < this.diseases.length; k++) {
                                if (id == this.diseases[k].groupId) {
                                    disName.push(this.diseases[k].name);
                                }
                            }
                        }
                    }
                }
                filterName.push("Disease: " + disName.join(",") + " ");
            }
            return filterName.join(" AND ");
        },
        loadFilter: function(e) {
            e.stopPropagation();
            this.clearForm();
            this.loadForm(e.currentTarget.dataFilter);
            this.$.filterHistoryTooltip.handleClose(e);
            this.submitForm();
        },
        clearFiltersHistory: function(e) {
            e.stopPropagation();
            this.historyFilters = [];
            localStorage.csvc_filter_history = JSON.stringify(this.historyFilters);

        },

        selectAllDiseases: function(e, d, s) {
            var name = (e.target != undefined && e.target.getAttribute("name") == "CSVS") ? "diseaseNameCSVS": "diseaseName";
            var checkboxes = this.$.filter_form.getElementsByClassName(name);
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        selectAllTechnologies: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("technologyName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = true;
            }

        },
        selectAllHighlights: function(e, d, s) {
           this.$.highlightsConsequenceTypes.selectAllHighlights(e,d,s);
            e.stopPropagation();
        },
        deselectAllDiseases: function(e, d, s) {
            var name = (e.target != undefined && e.target.getAttribute("name") == "CSVS") ? "diseaseNameCSVS": "diseaseName";
            var checkboxes = this.$.filter_form.getElementsByClassName(name);
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        },
        deselectAllTechnologies: function(e, d, s) {
            var checkboxes = this.$.filter_form.getElementsByClassName("technologyName");
            for (var i = 0; i < checkboxes.length; i++) {
                var elem = checkboxes[i];
                elem.checked = false;
            }
        },

        deselectAllHighlights: function(e, d, s) {
            this.$.highlightsConsequenceTypes.deselectAllHighlights(e,d,s);
            e.stopPropagation();
        },

        urlChanged: function(neo, old) {

            var me = this;

            if (neo == null || neo == "") {
                return;
            }
            this.request = {
                url: this.formURL,
                auxTotalCount: -1,
                parse: function(response) {
                    return CSVSSearchParse._parse(response);
                },
                parseTotal: function(response) {
                    var total = CSVSSearchParse._parseTotal(response);

                    me.numTotalResults = total;

                    if (this.auxTotalCount == -1) {

                        this.auxTotalCount = total;

                        this.url = this.url.replace("&skipCount=false", "&skipCount=true");

                    } else {
                        me.numTotalResults = this.auxTotalCount;
                        total = me.numTotalResults;
                    }

                    me.set('numTotalResults', -1);
                    me.set('numTotalResults', total);
                    return total;
                },
            };

        },

        _getWorst: function(listConsType) {
            var worst = {};

            listConsType.forEach(ct => {
                var obj;
                for (var i = 0; i < this.highlightsSO.groupValues.length; i++) {
                    obj = this.highlightsSO.groupValues[i].ops.find(h => h.name === ct) ;
                    if (!!obj && !!obj.order && (worst.order == undefined || obj.order < worst.order)) {
                        worst.ct = ct;
                        worst.order = obj.order;
                    }
                }
              return worst;
            });
            return worst.ct;
        },



        // Get data search to conctact
        getDataSearch: function(e){
            var data_search = {};
            data_search.regionsSearch = this.$.filterPosition.checkRegion();
            data_search.geneSearch = this.$.filterPosition.checkGene();


            var diseaseEls = this.$.diseases_div.querySelectorAll(".diseaseName");
            var diseaseIds = [];
            diseaseEls.forEach(function(d){
                if (d.checked)
                    diseaseIds.push(d.getAttribute("value"));
            });

            var technologyEls = this.$.technologies_div.querySelectorAll(".technologyName");
            var technologyIds = [];
            technologyEls.forEach(function(t){
                if (t.checked)
                    technologyIds.push(t.getAttribute("value"));
            });
            data_search.diseasesSearch = diseaseIds.join(",");
            data_search.technologiesSearch = technologyIds.join(",");
            e.target.search = data_search;
         },

        // enable scroll when popup is closed
        enableScroll: function(e){
            this.$.dataTable.handleScroll = function(e) {
                if (this.enablePaging == true) {
                    e.preventDefault();
                    if (e.deltaY > 0) {
                        this.handleNextClick();
                    }
                    if (e.deltaY < 0) {
                        this.handlePreviousClick();
                    }
                }
            }
        },
        // disable scroll when popup is closed
        disableScroll: function(e){
            this.$.dataTable.handleScroll =  function(e) { }
        },

        handleRowClick: function(e) {
            var row = e.detail.row;

            // Call if change row
            if (this.$.effect.row != row){
                this.$.gv.genomeViewer.setRegion(row);
                this.$.effect.row = row;
                this.$.frequency.row = row;
                this.$.phenotype.row = row;
                this.$.pharmacogenomic.row = row;
                var diseaseIds = Array.from(this.$.diseases_div.querySelectorAll(".diseaseName")).filter(d=>d.checked).map(d=>d.getAttribute("value"));
                this.$.methylation.filters = {diseases: diseaseIds };
                this.$.methylation.data = row;
            }

        },
        handleMenuClick: function(e) {
            this.selectedMenuTool = e.currentTarget;
        },
        selectedMenuChanged: function(neo, old) {
            if (old) {
                old.removeAttribute('selected');
                this.$[old.dataset.option].setAttribute('hidden', '');
            }
            if (neo && !this.hidden) {
                neo.setAttribute('selected', '');
                this.$[neo.dataset.option].removeAttribute('hidden');
            }
        },
        handleGenomeViewerCreated: function() {
            var me = this;

            var adapter = new FeatureTemplateAdapter({
                uriTemplate: CSVS_HOST + '/regions/{region}/fetch',

                species: this.$.gv.genomeViewer.species,
                parse: function(response) {
                    var itemsArray = [];

                    for (var i = 0; i < response.result.length; i++) {
                        var r = response.result[i];
                        for (var j = 0; j < r.length; j++) {
                            var elem = r[j];
                            elem.start = elem.position;
                            elem.end = elem.position;
                        }
                        itemsArray.push(r);
                    }

                    return itemsArray;
                },
                parseHistogram: function(response) {
                    var itemsArray = [];
                    for (var i = 0; i < response.result.length; i++) {
                        var r = response.result[i]
                        for (var j = 0; j < r.length; j++) {
                            var interval = r[j];
                            interval.features_count = interval.featuresCount;
                            console.log(interval.features_count);
                            itemsArray.push(interval);
                        }
                    }
                    return itemsArray;
                }
            });

            var args = FEATURE_TYPES.undefined;
            args.handlers = {
                "feature:click": function(e) {

                    var elem = e.feature;
                    console.log(elem);

                    me.$.dataTable.selectElem(elem, function(x, y) {
                        return x.chromosome == y.chromosome && x.position == y.position &&
                            x.reference == y.reference && x.alternate == y.alternate;
                    });
                }
            }

            var track = new FeatureTrack({
                title: window.ACRONYM_APP ||'CSVS',
                featureType: window.ACRONYM_APP || 'csvs',
                minHistogramRegionSize: 12000,
                maxLabelRegionSize: 3000,
                height: 120,
                renderer: new FeatureRenderer(args),
                dataAdapter: adapter
            });

            this.$.gv.genomeViewer.addTrack(track);
        },
        diseasesChanged: function(neo, old) {

            if (neo && Array.isArray(neo)) {
                var diseasesSort = [];
                var diseaseMap = {};
                var diseaseNameMap = {};

                for (var i = 0; i < neo.length; i++) {
                    diseasesSort.push(neo[i]);
                    diseaseMap[neo[i].groupId] = neo[i];
                    diseaseNameMap[neo[i].name] = neo[i];
                }

                diseasesSort.sort(function(a, b) {
                    return b.samples - a.samples;
                });
                this.diseasesSort = diseasesSort;
                this.diseaseMap = diseaseMap;
                this.diseaseNameMap = diseaseNameMap;
            }
        },
        _getDiseaseCount: function(data, disease) {
            var count = 0;

            for (var i = 0; i < data.length; i++) {
                var elem = data[i];
                if (elem.diseaseId == disease.groupId) {
                    count = elem.count;
                }
            }
            return count;
        },
        removeZeroValues: function(data) {
            var auxTable = [];

            for (key in data) {
                var row = data[key];
                auxTable.push(row);
            }

            if (auxTable.length > 0) {
                var len = auxTable[0].length;

                for (var j = 0; j < len; j++) {
                    var allZero = true;

                    for (var i = 0; i < auxTable.length && allZero; i++) {
                        if (auxTable[i][j] != undefined &&  auxTable[i][j].count != 0) {
                            allZero = false;
                        }

                    }

                    if (allZero) {
                        for (var i = 0; i < auxTable.length; i++) {
                            auxTable[i][j] = null;
                        }
                    }
                }

                for (key in data) {
                    data[key] = data[key].filter(function(row) {
                        return row != null;
                    })
                }
            }
        },
        reloadChart: function(data) {
            var me = this;
            var chartData = [];

            var diseaseBreaks = [];
            var diseaseBreaksCheck = false;

            this.removeZeroValues(data);

            for (var key in data) {
                var diseaseData = data[key];

                if (!diseaseBreaksCheck) {
                    diseaseBreaksCheck = true;
                    diseaseBreaks = Array(diseaseData.length).fill(0);
                    var totalSample = 0;
                    for (var i = 0; i < diseaseData.length; i++) {
                        var elem = diseaseData[i];
                        totalSample += elem.samples;
                        diseaseBreaks[i] = elem.samples;
                    }
                    for (var i = 0; i < diseaseBreaks.length; i++) {
                        var value = Math.floor((diseaseBreaks[i] / totalSample) * 50);
                        diseaseBreaks[i] = {
                            from: i,
                            to: i,
                            breakSize: value
                        }
                    }
                    diseaseBreaks.unshift({
                        from: 0,
                        to: 0,
                        breakSize: 0
                    });
                }
                var counts = [];

                var labels = [];
                var total = 0;
                var j = 0;
                for (var i = 0; i < diseaseData.length; i++) {
                    var elem = diseaseData[i];
                    var dis = this.diseaseMap[elem.diseaseId];

                    labels.push(dis.name);
                    counts.push({
                        x: elem.samples,
                        y: elem.count,
                        _count: elem.count,
                        _samples: elem.samples,
                        _disease: dis.name
                    });

                    total += elem.count;
                }

                for (var i = 1; i < counts.length; i++) {
                    counts[i].y += counts[i - 1].y;
                    counts[i].x += counts[i - 1].x;
                }
                for (var i = 0; i < counts.length; i++) {
                    counts[i].marker = {enabled: true};
                    counts[i].marker.radius = counts[i]._count / 5; //1/(counts[i]._count);
                    counts[i].marker.fillColor = Highcharts.color(Highcharts.getOptions().colors[chartData.length]).setOpacity(0.7).get('rgba');
                    if (counts[i].marker.radius > 120) {
                        counts[i].marker.radius = 120;
                        counts[i].marker.lineWidth = 5;
                        counts[i].marker.lineColor = Highcharts.color('#dddddd').setOpacity(0.7).get('rgba');
                    }
                }

                labels.unshift(
                    ""
                );
                counts.unshift({
                    y: 0,
                    x:0
                });


                chartData.push({
                    name: key,
                    data: counts
                });
            }
            me.$.tvSaturation.dataSaturation=chartData;

            var chart = new Highcharts.Chart({
                _me: me,

                loading: {
                    labelStyle: {
                        color: '#445D76',
                        fontSize: "18px"
                    },
                    style: {
                        backgroundColor:'rgba(150,150,150,0.2)'
                    }
                },
                chart: {
                    type: 'line',
                    plotBackgroundColor: null,
                    plotBorderWidth: 1,
                    plotShadow: false,
                    renderTo: this.$.chart,
                    borderRadius: 10,
                   // width: 1000,
                    height: 700,
                    minWidth:900,
                    pointStart: 0,
                    _me: me
                },
                exporting: {},
                title: {
                    text: "Saturation"
                },
                tooltip: {
                    useHTML: true,
                    formatter: function() {
                        var point = this.point;
                        if(point._samples != undefined)
                            return ' Disease Group: <b>' + point._disease + '</b><br> New Variants: <b>' + point._count + '</b> <br> Acum. Variants: <b>' + this.y + '</b></br>Samples: <b>' + point._samples + '</b>' +
                                '</br>Acum. Samples: <b>' + this.x + '</b>';
                        else
                            return ' Disease Group: <b> </b><br> New Variants: <b>0 </b> <br> Acum. Variants: <b>0 </b></br>Samples: <b> 0</b>';
                    }
                },
                credits: {
                    enabled: false
                },
                xAxis: {
                    labels: {
                        rotation: 335
                    },
                    crosshair: {
                        width: 2,
                        color: 'gray',
                        dashStyle: 'shortdot'
                    },
                    title: {
                        text: 'Num. samples'
                    },
                },

                yAxis: {
                    title: {
                        text: 'Num. variants'
                    },
                    min: 0,
                    startOnTick: true,
                    crosshair: {
                        width: 2,
                        color: 'gray',
                        dashStyle: 'shortdot'
                    }                },
                plotOptions: {
                    line: {
                        dataLabels: {
                            enabled: true
                        }
                    }
                },
                series: chartData
            });

            if (this.loadingSaturation && Object.entries(data).length == 0)
                chart.showLoading('<i class="fa fa-circle-o-notch fa-spin"></i> Loading... ');
            else
                chart.hideLoading();

        }
    });
</script>
